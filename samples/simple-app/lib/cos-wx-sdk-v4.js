"use strict";function CosCloud(t){this.appid=t.appid,this.bucket=t.bucket,this.region=t.region,this.sign_url=t.sign_url,t.getAppSign&&(this.getAppSign=t.getAppSign),t.getAppSignOnce&&(this.getAppSignOnce=t.getAppSignOnce)}function fixPath(t,e){if(!t)return"";var o=this;return t=t.replace(/(^\/*)|(\/*$)/g,""),t="folder"==e?encodeURIComponent(t+"/").replace(/%2F/g,"/"):encodeURIComponent(t).replace(/%2F/g,"/"),o&&(o.path="/"+o.appid+"/"+o.bucket+"/"+t),t}var SLICE_SIZE_512K=524288,SLICE_SIZE_1M=1048576,SLICE_SIZE_2M=2097152,SLICE_SIZE_3M=3145728,MAX_UNSLICE_FILE_SIZE=20971520;CosCloud.prototype.cosapi_cgi_url="https://REGION.file.myqcloud.com/files/v2/",CosCloud.prototype.sliceSize=3145728,CosCloud.prototype.getExpired=function(t){return parseInt(Date.now()/1e3)+(t||60)},CosCloud.prototype.set=function(t){t&&(this.appid=t.appid,this.bucket=t.bucket,this.region=t.region,this.sign_url=t.sign_url,t.getAppSign&&(this.getAppSign=t.getAppSign),t.getAppSignOnce&&(this.getAppSignOnce=t.getAppSignOnce))},CosCloud.prototype.getCgiUrl=function(t){var e=this.region,o=this.bucket,i=this.cosapi_cgi_url;return i=i.replace("REGION",e),i+this.appid+"/"+o+"/"+t},CosCloud.prototype.getAppSign=function(t,e,o){var i=this.getExpired(),s=o||this.bucket,r=this.sign_url+"?sign_type=appSign&expired="+i+"&bucketName="+s;wx.request({url:r,method:"GET",success:t,fail:e})},CosCloud.prototype.getAppSignOnce=function(t,e,o,i){var s=this.sign_url+"?sign_type=appSign_once&path="+encodeURIComponent(o)+"&bucketName="+i;wx.request({url:s,method:"GET",success:t,fail:e})},CosCloud.prototype.updateFolder=function(t,e,o,i,s){i=fixPath.call(this,i,"folder"),this.updateBase(t,e,o,i,s)},CosCloud.prototype.updateFile=function(t,e,o,i,s){i=fixPath.call(this,i),this.updateBase(t,e,o,i,s)},CosCloud.prototype.updateBase=function(t,e,o,i,s,r,a){var p=this;p.getAppSignOnce(function(o){var n=p.getCgiUrl(i),u={op:"update"};s&&(u.biz_attr=s),r&&(u.authority=r),a&&(a=JSON.stringify(a),u.customHeaders=a),wx.request({method:"POST",url:n,header:{Authorization:o},data:u,success:t,fail:e})})},CosCloud.prototype.deleteFolder=function(t,e,o,i){i=fixPath.call(this,i,"folder"),this.deleteBase(t,e,o,i)},CosCloud.prototype.deleteFile=function(t,e,o,i){i=fixPath.call(this,i),this.deleteBase(t,e,o,i)},CosCloud.prototype.deleteBase=function(t,e,o,i){if("/"==i)return void e({code:10003,message:"不能删除Bucket"});var s=this;this.getAppSignOnce(function(o){var r=s.getCgiUrl(i),a={op:"delete"};wx.request({method:"POST",url:r,header:{Authorization:o},data:a,success:t,fail:e})})},CosCloud.prototype.getFolderStat=function(t,e,o,i){i=fixPath(i,"folder"),this.statBase(t,e,o,i)},CosCloud.prototype.getFileStat=function(t,e,o,i){i=fixPath(i),this.statBase(t,e,o,i)},CosCloud.prototype.statBase=function(t,e,o,i){var s=this;this.getAppSign.call(s,function(o){var r=s.getCgiUrl(i),a={op:"stat"};wx.request({url:r,method:"GET",header:{Authorization:o},data:a,success:t,fail:e})})},CosCloud.prototype.createFolder=function(t,e,o,i,s){var r=this;this.getAppSign(function(o){i=fixPath(i,"folder");var a=r.getCgiUrl(i),p={op:"create",biz_attr:s||""};wx.request({method:"POST",url:a,header:{Authorization:o},data:p,success:t,fail:e})})},CosCloud.prototype.copyFile=function(t,e,o,i,s,r){var a=this;this.getAppSign(function(o){i=fixPath(i);var p=a.getCgiUrl(i),n={op:"copy",dest_fileid:s,to_over_write:r};wx.request({method:"POST",url:p,header:{Authorization:o},data:n,success:t,fail:e})})},CosCloud.prototype.moveFile=function(t,e,o,i,s,r){var a=this;this.getAppSign(function(o){i=fixPath(i);var p=a.getCgiUrl(i),n={op:"move",dest_fileid:s,to_over_write:r};wx.request({method:"POST",url:p,header:{Authorization:o},data:n,success:t,fail:e})})},CosCloud.prototype.getFolderList=function(t,e,o,i,s,r,a,p,n){var u=this;i=fixPath(i,"folder"),u.listBase(t,e,o,i,s,r,a,p)},CosCloud.prototype.listBase=function(t,e,o,i,s,r,a,p,n){var u=this;u.getAppSign(function(o){var n=u.getCgiUrl(i);s=s||20,r=r||"",a=a||0,p=p||"eListBoth";var l={op:"list",num:s,context:r,order:a,pattern:p};wx.request({url:n,method:"GET",header:{Authorization:o},data:l,success:t,fail:e})})},CosCloud.prototype.uploadFile=function(t,e,o,i,s,r){var a=this;i=fixPath(i),a.getAppSign(function(o){var p=a.getCgiUrl(i),n={op:"upload"};r>=0&&(n.insertOnly=r),wx.uploadFile({url:p,filePath:s,name:"fileContent",header:{Authorization:o},formData:n,success:function(e){e.data=JSON.parse(e.data),t.call(this,e)},fail:e})})},module.exports=CosCloud;